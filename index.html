<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Minha Visual Novel ‚Äî Demo Expandida (com Intro)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent:#ff88bb;
      --panel: rgba(8,8,10,0.78);
      --bg:#0f0f10;
      --text:#ff88bb;
    }

    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: Inter, Arial, sans-serif; overflow:hidden; }

    /* --- Intro / Loading / Menu / Game containers --- */
    #studioIntro, #loadingScreen, #mainMenu, #gameUI{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; }

    /* studio intro full-image */
    #studioIntro{ z-index:60; background: #000 center/cover no-repeat; }
    #studioIntro .overlay{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.35)); }
    #studioIntro .skip{ position:absolute; right:14px; top:14px; z-index:70; padding:8px 10px; border-radius:8px; background:rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.06); cursor:pointer; font-size:13px; }

    /* loading */
    #loadingScreen{ z-index:55; background:linear-gradient(180deg,#06060a,#0f0f10); display:none; }
    .loaderBox{ width:60%; max-width:720px; min-width:320px; text-align:center; }
    .progressOuter{ width:100%; height:18px; background:rgba(255,255,255,0.06); border-radius:10px; overflow:hidden; margin-top:16px; }
    .progressInner{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent), #ffd3e6); transition:width .2s linear; }
    .loadingText{ margin-top:10px; font-size:14px; opacity:0.9; }

    /* main menu (kept from original but hidden until after loading) */
    #mainMenu{ z-index:40; display:none; background: url("https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiY0m72dpb6KfJTgN6u1nD3jtpsjc76e0Dr1WnGk6k2YaEWF4ejJBCQUyXUJiUQqAKbOi1PYokFjC9qy3Zi6Sbc1yS6KxmUytYtVf2REjuXuFG9RBrEVLLHt7byTPOuAnxuX4gYkvEnGB92UBU4Ir2Mfa8sJ6FUa0FSTDESs3BklkBUC1b2KissTJRFUOW8/w945-h600-p-k-no-nu/ChatGPT%20Image%2015%20de%20set.%20de%202025,%2014_36_16.png") center/cover no-repeat; }

    #menuInner{ background: linear-gradient(0deg, rgba(0,0,0,0.0), rgba(0,0,0,0.0)); width: 100vw; height: 100vh; padding: 0; border-radius: 0; text-align: center; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; }
    #menuInner h1{ margin:0 0 12px 0; font-size:34px; text-shadow: 0 2px 6px rgba(0,0,0,0.6); }

    .menuBtn{ padding:12px 28px; margin:8px; border-radius:10px; border:2px solid var(--accent); background:rgba(0,0,0,0.5); color:var(--text); cursor:pointer; font-size:16px; }
    .menuBtn:hover{ background:var(--accent); color:black; }

    /* Credits modal */
    #creditsModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:200; background:rgba(0,0,0,0.6); }
    #creditsCard{ width:90%; max-width:520px; background:linear-gradient(180deg, rgba(10,10,12,0.98), rgba(8,8,10,0.95)); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.6); color:var(--text); border:1px solid rgba(255,255,255,0.04); }
    #creditsCard h3{ margin:0 0 10px 0; font-size:20px; }
    #creditsCard p{ margin:6px 0; font-size:15px; }

    /* game UI (copied/kept) */
    #gameUI{ display:none; }
    #background{ position:absolute; inset:0; background:#222 center/cover no-repeat; z-index:0; transition:background-image .35s ease; }
    #char { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); height: 80%; max-height: 100%; z-index: 1; opacity: 0; transition: opacity .25s ease; pointer-events: none; }
    #hud{ position:absolute; top:12px; left:12px; z-index:30; display:flex; gap:12px; align-items:center; }
    #hud .box{ background:var(--panel); padding:8px 12px; border-radius:8px; font-size:14px; }
    #dialogueBox{ position:absolute; left:6%; right:6%; bottom:4%; background:var(--panel); padding:18px; border-radius:12px; z-index:20; box-sizing:border-box; display:none; }
    #dialogue{ font-size:18px; line-height:1.4; min-height:48px; white-space:pre-wrap; }
    #choices{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    #choices button{ padding:10px 14px; border-radius:8px; border:none; cursor:pointer; background:var(--accent); color:black; font-weight:600; }
    #choices button:hover{ transform:translateY(-2px); }

    .small{font-size:13px; opacity:.9; }

    /* responsive tweaks */
    @media (max-width:520px){ .loaderBox{ width:88%; } #menuInner h1{ font-size:22px; } #creditsCard{ padding:12px; } #dialogue{ font-size:16px; } }
  </style>
</head>
<body>

<audio id="bgm" autoplay loop>
  <source src="https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Komiku/Komiku_Best_Of/Komiku_-03-_Rainy_Day.mp3" type="audio/mpeg">
  Seu navegador n√£o suporta √°udio.
</audio>

  <!-- STUDIO INTRO (uses user-provided image) -->
  <div id="studioIntro">
    <div class="overlay"></div>
    <button class="skip" onclick="skipIntro()">Pular Intro (Esc)</button>
  </div>

  <!-- LOADING SCREEN -->
  <div id="loadingScreen" style="display:none;">
    <div class="loaderBox">
      <h2>Carregando o jogo...</h2>
      <div class="progressOuter"><div class="progressInner" id="progressInner"></div></div>
      <div class="loadingText" id="loadingText">0%</div>
      <p class="small" style="margin-top:8px">Dica: pressione <strong>Espa√ßo</strong> para avan√ßar nas falas. Pressione Espa√ßo de novo para pular o efeito de digita√ß√£o.</p>
    </div>
  </div>

  <!-- MAIN MENU (original) -->
  <div id="mainMenu">
    <div id="menuInner">
      <h1>üå∏ Al√©m dos Cochichos ‚Äî Demo</h1>
      <p class="small">Criado por: Yan Comerlatto Massoni</p>
      <div style="margin-top:18px">
        <button class="menuBtn" onclick="startGame()">Novo Jogo</button>
        <button class="menuBtn" onclick="loadState()">Carregar</button>
        <button class="menuBtn" onclick="openCredits()">Cr√©ditos</button>
      </div>
      <p class="small" style="margin-top:10px">Avance: <strong>Espa√ßo</strong> ‚Äî Escolhas: clique no bot√£o</p>
    </div>
  </div>

  <!-- Credits modal -->
  <div id="creditsModal" onclick="if(event.target===this) closeCredits()">
    <div id="creditsCard">
      <h3>Cr√©ditos</h3>
      <p><strong>Jogo criado por:</strong> Yan Comerlatto Massoni</p>
      <p><strong>C√≥digo por:</strong> ChatGPT</p>
      <p><strong>Artes por:</strong> ChatGPT</p>
      <p><strong>Roteiro:</strong> Yan Comerlatto Massoni</p>
      <p style="margin-top:10px" class="small">Clique fora ou em Fechar para voltar.</p>
      <div style="display:flex; justify-content:flex-end; margin-top:8px;">
        <button class="menuBtn" onclick="closeCredits()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- GAME UI (original) -->
  <div id="gameUI">
    <div id="background"></div>
    <img id="char" src="" alt="char">
    <div id="hud" style="display:none;">
      <div class="box">Al√©m dos Cochichos</div>
      <div class="box">Afeto: <span id="affectionValue">0</span></div>
      <div class="box small">Pressione Espa√ßo para avan√ßar</div>
    </div>

    <div id="dialogueBox">
      <div id="dialogue"></div>
      <div id="choices"></div>
    </div>
  </div>

<script>
/* --- Setup studio image (user link) --- */
const STUDIO_IMAGE = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8CpXJQuxJ20PJWMAwUt-IjF-2mvAeOLtijoNsf7IIMjD_mKIg3rbM3d3uwfy_ef1J4ha2JtJXnNJoc45GOW89U22eYVb-bq7zxNjLPXfj1R1HB4vHXOTRjJ9LYqvaH3J30LE7tBTB1EfwUJSwEK8S-CefqRnJpZDd9WHVNXw5PyP7p6eiy8z1TwMc5YoZ/w945-h600-p-k-no-nu/CRIADO%20POR.jpg";

const introDiv = document.getElementById('studioIntro');
introDiv.style.backgroundImage = `url('${STUDIO_IMAGE}')`;
introDiv.style.backgroundPosition = 'center';
introDiv.style.backgroundSize = 'cover';

let introSkipped = false;
function skipIntro(){ introSkipped = true; endIntro(); }

document.addEventListener('keydown', (e) => { if(e.key === 'Escape') skipIntro(); });

/* --- Credits functions --- */
function openCredits(){
  document.getElementById('creditsModal').style.display = 'flex';
}
function closeCredits(){
  document.getElementById('creditsModal').style.display = 'none';
}

/* --- Loading logic --- */
function showLoadingAndThenMenu(){
  document.getElementById('studioIntro').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'flex';

  const inner = document.getElementById('progressInner');
  const txt = document.getElementById('loadingText');
  let pct = 0;

  const interval = setInterval(() => {
    if(introSkipped) pct = 100;
    pct += Math.floor(Math.random()*8) + 6;
    if(pct >= 100) pct = 100;
    inner.style.width = pct + '%';
    txt.textContent = pct + '%';
    if(pct >= 100){
      clearInterval(interval);
      setTimeout(()=>{
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'flex';
      }, 350);
    }
  }, 160);
}

function endIntro(){
  const el = document.getElementById('studioIntro');
  el.style.transition = 'opacity .35s ease';
  el.style.opacity = 0;
  setTimeout(()=>{ el.style.display = 'none'; showLoadingAndThenMenu(); }, 380);
}

window.addEventListener('load', ()=>{
  setTimeout(()=>{
    if(!introSkipped) endIntro();
  }, 1800);
});

/* ---------- SPRITES + BACKGROUNDS + SCENES ---------- */

const SPRITES = {
  neutral: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhdG6e5sjfiLbvSbtVGxFIX_LmGxXh7wRWzg_ZgqxeDvxsAXAldYsgWPhyphenhyphentlbmJX4ZQnGl7ypGO6sed3JdnGqt3KC_pGsOXgD3TKnTsif8dK_gMBcwJ-8sD4IxKyzQamy7dIQSZhez4dSYQ4NH7X9SBjvIWVhREIkfctaoJQGg-qHMGQvtgJ9bsYpfpmz0U/s320/63ad9301-3cdc-4956-9826-aabba17021fc.png",
  uncomfortable: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj57HEfWxF7k2EwEY2qiX4w7kzhf_WXbhygRHNgOFmCDsn67USVncB37DrIKASpUpLVv055XzrPjQcR-Evv2AdXX7cpleZypH1JoEsnmG3MyBnI5i7Ae2EhQxIO0GMir2PQvsZo-hUEGkGU3Z_lacDG0a7nkNBWNBjBATObetW78RyvVvomEXFQoxJfnF6i/s320/38dbc72f-adc5-4736-a151-3f9de6e6a7d1-removebg-preview.png",
  embarrassed: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhsyGAEZ9nzbS8RpxfWa5TMZz5QWoR7wFj_j5qHGNGnu6qDQRjpyjwA-VE-pXfjG-ShHfqyUIzRiYsF74dfEw0tAgOVL6pspbfwe6LJczWMEJI87kW-PuI3qqsEYX8o0RgDageRemNCGCMX6iwt8jI-LbJEUcUf53nvIR71oFpZeWU41dXjC7TYkszEO_am/s320/image-removebg-preview%20(20).png",
  happy: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh9la3On91cbXMdMpHtbNBY8KA2EujruvL9NhjzrQ0C-97z5-QzPU5rNdvUSswIIYDrzkLmlr-VJWydfC8sDp5PjBamztTsqMJZGwmnR2EzdOD_8VNKqBepo32j8B0gTZwRiMo-iH8U7BD4vOjK-pNxiY_BRBxvAa1hnUq-0QSKwUQVClJ2Ff3BPj3iTWo6/s320/image-removebg-preview%20(21).png",
  sad: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjP6B6yiU2kgRbV-RFjrGi02YfUOAW28T4658XGJg2UDKpmeUEQtHzT62WB5XKAubxcSCnBHXWt9tlvJhotsgL1bq6rmNjPBL2LdbaDmgtkFvkyhVZrsgGGTHT6SklZJFwvZQNTHc-oX4PDFuvRbxGC-_GNlntAoMgJYEoIeNJfbc3vMK8v6zfU3Zh-bXBq/s320/image-removebg-preview%20(22).png",
  angry: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg3sQ77kGYV_0_uNMV82EiRzpNjr60lctM41yl8QWFixf9affV9kW1-HCFeR48ku8X9oDFlgWiGEgPDd9syFLMZgmBC9OmKsDFCFLqlIfZ4Aj42SaTWr_Qqxf70svG-A0e_L0jgGtOzFHqOllxzY5p4gL8yAZ17DyqoHnPinRmCzpoi-MunbRscLZGO3iRR/s320/image-removebg-preview%20(23).png",
  surprised: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEilnbH9h6X0cwNyy2X5_63Ml6DVktg3IdS3go4Zk8krhNhhLlsjEMVGY-PRKFjcPWiQ4LgmIQhhnz9HqzVA9LKdJUUJuR2GQBxw0hPPXXwBgAnzmEdWZz5EEP-meZBFdYI_dfcNjH0KEVaDzyxPgswnAd8ym3srLwCtE7js9lBUo-batFsJWzsYDDKNa57n/s320/3fdf9aee-6f8e-4324-a71a-6a23b6b6dd4e.png",
  romantic: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOSmp99WsQKTTi6f7L0soPMDlqptx4PNyIkzgqvrP3Zn5qrkpw5Tv8VWGKnRwq7cVFfI61_uGiyBX0qR-b7ayAmAOgMQrUOjsutXavbOzkgHjou1S4gr4holfvasFcwdNyc7PYEdQDbnyt3bm4j7MM9glTl7jN6kzIMESHWYa4dQumAkswcoRBIdWY7NH2/s320/459765c8-bc95-4be8-a9da-7fd2cb19b402.png"
};

const BACKGROUNDS = {
  classroom: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjJIdENAJVgqTQDsjT21lO4Rm2sc1IV3Qt-ViY76pamcH_OhUouZ0yvKbHAZ6pHt2O_vgyk6ftATy2sLXrE55MfNfTwlazc2DbkCT-0bT9uaXQSvyBuaPTRWFxTzDuSo_DIg2CH8W4o34H-_0doZdZS7o_80cbC8vPVHHv7JyBC0sz6PT5mR2EBVDx9xrkR/s320/1f28dff2-9eda-40dc-aa50-272e6f3d114d.png",
  hallway: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiwiK8RXZ2nlILZd6UGmDVOmDyQwB75RPkCajEf25wIYcc2lzVkelRyEGR-uqlpdUaUYfx6MXRNcsP61P6gwPwWTR0JgsiLjmanAu6fjIM_Ran9-uBVq-HOk8tO1sjAjdFAHRvVIknXgVHMQasCs56WHtIXvPs7UbONOR5ZiyqteuQ7pBhtAlm2p9xU-IMK/s320/302624f7-28c7-4504-997b-605a17d08aee.png",
  library: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidX2J7SNrB70DkBK722ZQJ_woMipa0yTd_8taF8Jze-qNvxHvlSy1dQCrvWTXs89mgSAdEtdDrdzqMdCgSlJ9wnFGO6BbDG9dl2UIDmPtYvTUUFKVvXvVwjQiS82a_MYqBk8qIMQL83yGSlfN3Qhtrb_keC2R3PaugNsZkf2Qs6ugyXHOQPAGz-5Yw1U3u/s320/dc5dbbf1-9147-481d-b212-8a725307a261.png",
  courtyard: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgtkCqfrwELTVFVub9ZsINhIoQyyoD6qCxhZu_D4_Yeml7jlN6GZbQdJr1AI6rWnyp9si3WKnlD3t7eb1GHc0ERvazctJWZu3nvWaC86dmPV9UI8srFINATAIOByoj5U3LQZpWw07k1M5Tvf0N-983645wpJvDwyk_-oAv0XDLtd9YCfiKM0u5f1xte-1qf/s320/25c9779d-f2b4-4bd2-9955-4fc3c1f36b49.png",
  street: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjU03KO_GkbUfBWgVQiDfd7A0r3mcSVdQGuQOa1elc0IZ59bu9Cdr4NAeaVQ9fZM7ScgxW8MGIaeLHyT57OzN95EZF62pGh0lfeEFaMiV52XLhSwSi6Ut4bljWRV4X3ApFX46IV40iIGZl6TuVUdAiOYSaOexa3w101uCb48A2u9cn_ECCInrM1EJlHIvQw/s320/f08408c7-9ab7-49f4-bea8-96c35ff47669.png"
};

const SCENES = [
  { bg:"classroom", sprite:"neutral", text:"Um dia comum na escola. O professor ainda n√£o chegou." },
  { bg:"classroom", sprite:"embarrassed", text:"A porta se abre devagar... uma aluna nova entra, todos olham." },
  { bg:"classroom", sprite:"embarrassed", text:"Ela fica em sil√™ncio, parecendo nervosa, e te encara por um instante." },
  { bg:"classroom", sprite:"uncomfortable", text:"A garota olha ao redor, como se procurasse um lugar para se sentar." },
  { bg:"classroom", sprite:"neutral", text:"Voc√™ levanta a m√£o e oferece a cadeira ao lado da sua." },
  { bg:"classroom", sprite:"embarrassed", text:"Ela se aproxima, corada, e se senta timidamente ao seu lado." },
  { bg:"classroom", sprite:"embarrassed", text:"A aula passa devagar; voc√™ percebe que ela risca a caneta no caderno, inquieta." },
  { bg:"hallway", sprite:"embarrassed", text:"O sinal toca. No corredor, voc√™ a encontra novamente.", choice:[
      { text:"Puxar conversa ‚Äî 'Tudo bem?'", next:9, affection:+1 },
      { text:"Apenas acenar e seguir", next:10, affection:0 }
    ]
  },
  { bg:"hallway", sprite:"embarrassed", text:"‚Äî O-oi... obrigada por antes ‚Äî ela diz, desviando o olhar." },
  { bg:"hallway", sprite:"neutral", text:"Ela sorri timidamente e responde seu nome: 'Mika'." },
  { bg:"library", sprite:"neutral", text:"Mais tarde, na biblioteca, voc√™ a encontra folheando um livro.", choice:[
      { text:"Perguntar sobre o livro", next:13, affection:+1 },
      { text:"Ficar em sil√™ncio e observar", next:14, affection:0 }
    ]
  },
  { bg:"library", sprite:"embarrassed", text:"‚Äî √â... um romance antigo. Eu gosto de coisas calmas ‚Äî ela sussurra, corando." },
  { bg:"library", sprite:"romantic", text:"Voc√™s conversam sobre personagens, e ela relaxa perto de voc√™." },
  { bg:"library", sprite:"sad", text:"Ela fecha o livro leve e volta a ler. Voc√™ sente um frio na barriga por n√£o ter falado." },
  { bg:"courtyard", sprite:"happy", text:"No p√°tio, o sol da tarde ilumina os bancos. Ela parece nervosa.", choice:[
      { text:"Sentar ao lado dela e oferecer um lanche", next:17, affection:+2 },
      { text:"Ignorar e falar com os amigos", next:18, affection:-1 }
    ]
  },
  { bg:"courtyard", sprite:"romantic", text:"Ela sorri surpreso: 'Voc√™ trouxe...? Obrigada, estava com fome.' Ela come e se abre sobre a fam√≠lia.'"},
  { bg:"courtyard", sprite:"embarrassed", text:"Mika confessa que se mudou recentemente e sente falta de antigos amigos." },
  { bg:"courtyard", sprite:"sad", text:"Ela abaixa a cabe√ßa. Voc√™ v√™ nos olhos dela uma tristeza que te incomoda depois." },
  { bg:"street", sprite:"romantic", text:"Na sa√≠da da escola, voc√™s caminham juntos. A rua est√° calma.", choice:[
      { text:"Convid√°-la para um caf√© ap√≥s as aulas", next:21, affection:+1 },
      { text:"Dizer que tem planos e ir embora", next:22, affection:-1 },
      { text:"Sugerir um encontro em grupo com amigos", next:23, affection:0 }
    ]
  },
  { bg:"street", sprite:"surprised", text:"‚Äî Um caf√©? ‚Äî ela pergunta surpresa, corando: 'Eu aceito!'" },
  { bg:"street", sprite:"romantic", text:"No caf√©, a conversa flui. Voc√™ descobre gostos semelhantes." },
  { bg:"street", sprite:"embarrassed", text:"‚Äî Tudo bem ‚Äî ela diz baixinho. Voc√™ se pergunta se deveria ter ficado." },
  { bg:"street", sprite:"neutral", text:"‚Äî Um encontro com amigos pode ser legal ‚Äî ela sorri timidamente, aliviada." },
  { bg:"classroom", sprite:"angry", text:"Na semana seguinte, um colega provoca Mika por ser nova. Ela fica nervosa.", choice:[
      { text:"Intervir e defender Mika", next:27, affection:+2 },
      { text:"Ficar calado por medo", next:28, affection:-2 }
    ]
  },
  { bg:"classroom", sprite:"angry", text:"Voc√™ levanta a voz: 'Para com isso.' O provocador recua; Mika te olha com admira√ß√£o." },
  { bg:"classroom", sprite:"romantic", text:"Depois da aula, Mika deixa um bilhete agradecendo." },
  { bg:"classroom", sprite:"sad", text:"Voc√™ n√£o diz nada. Mika parece magoada quando o colega ri." },
  { bg:"classroom", sprite:"sad", text:"Mais tarde, voc√™ a encontra distante, evitando olhar para voc√™." },
  { bg:"courtyard", sprite:"happy", text:"Convite aceito ‚Äî voc√™s marcam de estudar juntos na biblioteca.", choice:[
      { text:"Estudar com aten√ß√£o", next:31, affection:+1 },
      { text:"Ficar s√≥ no celular e conversar pouco", next:32, affection:-1 }
    ]
  },
  { bg:"library", sprite:"neutral", text:"A sess√£o de estudos √© produtiva. Mika comenta que aprende bem com voc√™." },
  { bg:"library", sprite:"romantic", text:"Voc√™s riem de uma parte do livro e a tens√£o se desfaz." },
  { bg:"library", sprite:"embarrassed", text:"Voc√™ passa mais tempo no celular. Mika parece desapontada, mas tenta disfar√ßar." },
  { bg:"street", sprite:"surprised", text:"Chega perto do final do semestre: um festival escolar ser√° realizado.", choice:[
      { text:"Oferecer companhia para o festival", next:35, affection:+1 },
      { text:"Ignorar, est√° cansado", next:36, affection:-1 },
      { text:"Convidar ela para a apresenta√ß√£o que voc√™ vai acompanhar", next:37, affection:+1 }
    ]
  },
  { bg:"courtyard", sprite:"romantic", text:"No festival, as luzes, a comida e as barracas criam um clima m√°gico." },
  { bg:"courtyard", sprite:"romantic", text:"Mika agarra sua m√£o por impulso e sorri ‚Äî voc√™s conversam como nunca." },
  { bg:"street", sprite:"sad", text:"Voc√™ n√£o vai. Devolve um convite por mensagem. Mika responde algo curto." },
  { bg:"classroom", sprite:"embarrassed", text:"Ela aceita com alegria: 'Adoraria ir com voc√™'." },
  { bg:"classroom", sprite:"uncomfortable", text:"Um boato come√ßa a circular: dizem que voc√™ s√≥ quer aten√ß√£o. Mika fica confusa.", choice:[
      { text:"Explicar a verdade sinceramente", next:41, affection:+2 },
      { text:"Rir e n√£o levar a s√©rio", next:42, affection:-1 }
    ]
  },
  { bg:"classroom", sprite:"romantic", text:"Voc√™ explica que se importa e que as mentiras te incomodam. Mika chora de al√≠vio." },
  { bg:"classroom", sprite:"angry", text:"Voc√™ ri e tenta minimizar; Mika se afasta, magoada." },
  { bg:"street", sprite:"neutral", text:"Semana final. Mika te encontra sozinho e olha nos seus olhos: 'Tem algo a dizer?'", choice:[
      { text:"Dizer como se sente (declara√ß√£o)", next:1000, affection:+2 },
      { text:"N√£o falar nada e esperar", next:1001, affection:0 },
      { text:"Falar algo gen√©rico, sem compromisso", next:1002, affection:-1 }
    ]
  }
];

/* ---------- ENGINE & TYPING EFFECT ---------- */

function setSprite(key){ const char = document.getElementById("char"); if(!key){ char.style.opacity = 0; return; } char.src = SPRITES[key] || ""; char.style.opacity = 1; }
function setBackground(key){ const bg = document.getElementById("background"); bg.style.backgroundImage = `url('${BACKGROUNDS[key] || BACKGROUNDS.classroom}')`; }
function updateHud(){ document.getElementById("affectionValue").textContent = state.affection; document.getElementById("hud").style.display = "flex"; }

let state = { sceneIndex: 0, affection: 0 };

/* Typing control variables */
const TYPING_SPEED = 22; // ms per char (ajuste aqui)
let typingTimer = null;
let currentlyTyping = false;
let fullTextQueued = ""; // texto que est√° sendo digitado
let charPos = 0;

/* typeText: digita texto caractere por caractere no #dialogue
   - se 'immediate' = true, mostra todo texto imediatamente (pula)
   - retorna uma Promise que resolve quando a digita√ß√£o terminar
*/
function typeText(text, immediate = false){
  return new Promise((resolve) => {
    const dlg = document.getElementById("dialogue");
    clearInterval(typingTimer);
    currentlyTyping = false;
    fullTextQueued = text || "";
    charPos = 0;
    dlg.textContent = "";

    if(immediate || TYPING_SPEED <= 0){
      dlg.textContent = fullTextQueued;
      currentlyTyping = false;
      fullTextQueued = "";
      resolve();
      return;
    }

    currentlyTyping = true;
    typingTimer = setInterval(() => {
      // add next char
      charPos++;
      dlg.textContent = fullTextQueued.slice(0, charPos);
      // auto-complete punctuation pauses can be added here if desired
      if(charPos >= fullTextQueued.length){
        clearInterval(typingTimer);
        currentlyTyping = false;
        fullTextQueued = "";
        resolve();
      }
    }, TYPING_SPEED);
  });
}

/* Call this to immediately finish current typing (if any) */
function finishTypingImmediately(){
  if(!currentlyTyping) return;
  clearInterval(typingTimer);
  document.getElementById("dialogue").textContent = fullTextQueued;
  currentlyTyping = false;
  fullTextQueued = "";
}

/* ---------- RENDERING SCENES ---------- */

function renderScene(){
  const idx = state.sceneIndex;
  if(idx === 1000 || idx === 1001 || idx === 1002){ renderEnding(idx); return; }
  const scene = SCENES[idx];
  if(!scene){ renderEnding(null); return; }

  document.getElementById("dialogueBox").style.display = "block";
  document.getElementById("gameUI").style.display = "block";
  setBackground(scene.bg);
  setSprite(scene.sprite);
  updateHud();

  const choiceBox = document.getElementById("choices");
  choiceBox.innerHTML = "";

  // Start typing, then show choices (if exist) after typing completes.
  typeText(scene.text).then(() => {
    // after typing ended:
    if(scene.choice && Array.isArray(scene.choice)){
      choiceBox.style.display = "flex";
      scene.choice.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt.text;
        btn.onclick = () => {
          if(typeof opt.affection === "number") state.affection += opt.affection;
          if(state.affection > 99) state.affection = 99;
          if(state.affection < -99) state.affection = -99;
          state.sceneIndex = opt.next;
          renderScene();
        };
        choiceBox.appendChild(btn);
      });
    } else {
      choiceBox.style.display = "none";
    }
  }).catch(()=>{ /* ignore */});
}

function renderEnding(mode){
  const affection = state.affection;
  let endingType;
  if (mode === 1001) {
    if (affection >= 2) endingType = "best";
    else if (affection >= 0) endingType = "neutral";
    else endingType = "bad";
  } else if (mode === 1002) {
    if (affection >= 3) endingType = "best";
    else if (affection >= 1) endingType = "neutral";
    else endingType = "bad";
  } else if (mode === 1000) {
    if (affection >= 0) endingType = "best";
    else endingType = "neutral";
  } else {
    if (affection >= 3) endingType = "best";
    else if (affection >= 0) endingType = "neutral";
    else endingType = "bad";
  }

  if(endingType === "best"){
    setBackground("courtyard"); setSprite("romantic");
    typeText("Mika sorri com os olhos brilhando: 'Eu tamb√©m gosto de voc√™.' Voc√™s se aproximam sob as luzes do festival ‚Äî um come√ßo bonito para algo novo. ‚ù§\n\n[Fim ‚Äî Final Bom]", true).then(() => {
      showEndingChoices();
    });
  } else if(endingType === "neutral"){
    setBackground("street"); setSprite("embarrassed");
    typeText("H√° carinho e incerteza. Mika segura sua m√£o por um momento e depois solta com um sorriso t√≠mido. Voc√™s seguem amigos, talvez algo mais no futuro.\n\n[Fim ‚Äî Final Neutro]", true).then(() => {
      showEndingChoices();
    });
  } else {
    setBackground("classroom"); setSprite("sad");
    typeText("O sil√™ncio pesa. Mika se afasta gentilmente: 'Acho melhor...' Ela vai embora. Voc√™ fica com a sensa√ß√£o do que poderia ter sido.\n\n[Fim ‚Äî Final Ruim / Bittersweet]", true).then(() => {
      showEndingChoices();
    });
  }
}

function showEndingChoices(){
  const choiceBox = document.getElementById("choices");
  choiceBox.innerHTML = "";
  choiceBox.style.display = "flex";
  const btnRestart = document.createElement("button"); btnRestart.textContent = "Reiniciar"; btnRestart.onclick = () => { restartGame(); };
  const btnMenu = document.createElement("button"); btnMenu.textContent = "Voltar ao Menu"; btnMenu.onclick = () => { backToMenu(); };
  choiceBox.appendChild(btnRestart);
  choiceBox.appendChild(btnMenu);
}

/* ---------- NAVIGATION / STATE ---------- */

function nextScene(){
  const scene = SCENES[state.sceneIndex];
  // If typing is in progress -> finish it
  if(currentlyTyping){ finishTypingImmediately(); return; }

  // If current scene has choices, don't advance with space (user must click)
  if(scene && scene.choice) return;

  // otherwise advance
  state.sceneIndex++;
  renderScene();
}

function startGame(){ document.getElementById("mainMenu").style.display = "none"; document.getElementById("gameUI").style.display = "block"; state.sceneIndex = 0; state.affection = 0; renderScene(); }
function restartGame(){ state.sceneIndex = 0; state.affection = 0; renderScene(); }
function backToMenu(){ document.getElementById("mainMenu").style.display = "flex"; document.getElementById("gameUI").style.display = "none"; state.sceneIndex = 0; state.affection = 0; document.getElementById("hud").style.display = "none"; }

/* ---------- Save / Load ---------- */
function saveState(){ localStorage.setItem("vn_save", JSON.stringify(state)); alert("Jogo salvo!"); }
function loadState(){ const data = localStorage.getItem("vn_save"); if(!data){ alert("Nenhum save encontrado."); return; } state = JSON.parse(data); document.getElementById("mainMenu").style.display = "none"; document.getElementById("gameUI").style.display = "block"; renderScene(); }

/* ---------- Keyboard handling ---------- */
/* Espa√ßo: - se digitando -> pula e mostra tudo
           - se n√£o digitando e n√£o houver escolhas -> avan√ßa
   Ctrl+S: salvar (usado no HUD)
*/
document.addEventListener("keydown", (e) => {
  // avoid interfering while typing in input fields in future
  const active = document.activeElement;
  if(active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) return;

  if(e.code === "Space"){
    e.preventDefault();
    // If modal credits is open, close it with Esc/Space as well
    if(document.getElementById('creditsModal').style.display === 'flex'){
      closeCredits();
      return;
    }
    if(currentlyTyping){
      // finish typing immediately on first Space
      finishTypingImmediately();
      return;
    }
    // if not typing: try advance
    const scene = SCENES[state.sceneIndex];
    if(scene && scene.choice){
      // do nothing (choices require click)
      return;
    } else {
      nextScene();
    }
  }

  if(e.key.toLowerCase() === "s" && e.ctrlKey){
    e.preventDefault();
    saveState();
  }

  if(e.key === "Escape"){
    // close credits if open
    if(document.getElementById('creditsModal').style.display === 'flex'){
      closeCredits();
    }
  }
});

/* ---------- Quick HUD (save/load) ---------- */
(function addQuickHUDButtons(){
  const hud = document.getElementById("hud");
  const container = document.createElement("div");
  container.className = "box small";
  container.style.display = "flex";
  container.style.gap = "6px";
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Salvar";
  saveBtn.style.padding = "6px 8px";
  saveBtn.style.borderRadius = "6px";
  saveBtn.onclick = saveState;
  container.appendChild(saveBtn);
  const loadBtn = document.createElement("button");
  loadBtn.textContent = "Carregar";
  loadBtn.style.padding = "6px 8px";
  loadBtn.style.borderRadius = "6px";
  loadBtn.onclick = loadState;
  container.appendChild(loadBtn);
  hud.appendChild(container);
})();

/* ensure audio autoplay starts muted if blocked by browser, allow unmute later */
document.addEventListener('DOMContentLoaded', () => {
  const audio = document.getElementById('bgm');
  if(audio && audio.paused){
    audio.muted = true;
    audio.play().catch(()=>{ /* some browsers block autoplay ‚Äî muted fallback */});
  }
});

</script>
</body>
</html>



